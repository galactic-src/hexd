<html>
<head>

<script>

const rounded = (scalar) => Math.round(scalar*100)/100;

const getEdgeLength = () => document.getElementById('edge').value * 1;
const setEdgeLength = (edgeLength) => document.getElementById('edge').value = rounded(edgeLength);
const getCanvasContext = () => document.getElementById('output').getContext("2d");
const getCanvasHeight = () => document.getElementById('output').height * 1;
const getCanvasWidth = () => document.getElementById('output').width * 1;
const getXOffset = () => document.getElementById('x').value * 1;
const setXOffset = (xOffset) => document.getElementById('x').value = rounded(xOffset);
const getYOffset = () => document.getElementById('y').value * 1;
const setYOffset = (yOffset) => document.getElementById('y').value = rounded(yOffset);
const getImage = () => document.getElementById('hiddenImage');

function onXChanged(newXOffset) {
  if (newXOffset < 0) {
    setXOffset(0);
    setEdgeLength(getEdgeLength() - 1);
  } else {
    const canvasWidth = getCanvasWidth();
    const edgeLength = getEdgeLength();
    const hexWidth = edgeLength * Math.sqrt(3);
    const newHexRight = newXOffset + hexWidth; 

    if (newHexRight > canvasWidth) {
      const newEdge = (canvasWidth - newXOffset) / Math.sqrt(3);
      setEdgeLength(newEdge);
    }
  }

  redraw();
}

function onYChanged(newYOffset) {
  console.log(newYOffset);
  if (newYOffset < 0) {
    setYOffset(0)
    setEdgeLength(getEdgeLength() - 1);
  } else {
    const canvasHeight = getCanvasHeight();
    const edgeLength = getEdgeLength();
    const hexHeight = edgeLength * 2;
    const newHexBottom = newYOffset + hexHeight;

    if (newHexBottom > canvasHeight) {
      const newEdge = (canvasHeight - newYOffset) / 2;
      setEdgeLength(newEdge);
    }
  }

  redraw();
}

function redraw() {
  const ctx = getCanvasContext();
  copyImageToCanvas(ctx);
  cropHex(ctx);
  //drawHexOutline(ctx);
}

function onFileSelected(evt) {
  const selectedFile = event.target.files[0];
  if (selectedFile === undefined) {
    return;
  }

  const oldImg = getImage();
  if (oldImg !== null) {
    document.body.removeChild(oldImg);
  }

  const img = document.createElement('img');
  img.id = 'hiddenImage';
  img.origin = 'anonymous';
  img.src = URL.createObjectURL(selectedFile);
  img.style = "position:absolute; top: -9999px; left: -9999px;";
  img.onload = function() {
    const ctx = getCanvasContext();
    ctx.canvas.width = this.naturalWidth;
    ctx.canvas.height = this.naturalHeight;

    setDefaultHex(ctx);

		redraw();
  };

  document.body.appendChild(img);
}

function copyImageToCanvas(ctx) {
  resetCtx(ctx);
  ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
  ctx.drawImage(getImage(), 0, 0);
}

function setDefaultHex(ctx) {
  const ratio = ctx.canvas.height / ctx.canvas.width;

  const lengthFromWidth = ctx.canvas.width / Math.sqrt(3);
  const lengthFromHeight = ctx.canvas.height / 2;
  const edge = Math.min(lengthFromWidth, lengthFromHeight);
  const xOffset = (ctx.canvas.width / 2) - edge * Math.sqrt(3/4);
  const yOffset = (ctx.canvas.height / 2) - edge;

  setEdgeLength(edge);
  setXOffset(xOffset);
  setYOffset(yOffset);
}

function drawHexOutline(ctx) {
  const xOffset = getXOffset();
  const yOffset = getYOffset();
  const edge = getEdgeLength();

  resetCtx(ctx);
  ctx.beginPath();
	ctx.moveTo(xOffset, yOffset + edge * 0.5);
	ctx.lineTo(xOffset, yOffset + edge * 1.5);
	ctx.lineTo(xOffset + edge * Math.sqrt(3/4), yOffset + edge * 2);
	ctx.lineTo(xOffset + edge * Math.sqrt(3), yOffset + edge * 1.5);
	ctx.lineTo(xOffset + edge * Math.sqrt(3), yOffset + edge * 0.5);
	ctx.lineTo(xOffset + edge * Math.sqrt(3/4), yOffset);
	ctx.lineTo(xOffset, yOffset + edge * 0.5);
	ctx.stroke();
}

function cropHex(ctx) {
  const edge = getEdgeLength();
  const hexLeft = getXOffset();
  const hexTop = getYOffset();

  const hexHeight = edge * 2;
  const hexBottom = hexTop + hexHeight; 

  const hexWidth = edge * Math.sqrt(3);
	const hexRight = hexLeft + hexWidth;
  const hexMiddle = hexLeft + hexWidth/2;

	resetCtx(ctx);
  ctx.globalCompositeOperation = 'destination-out';

  if (hexTop > 0) {
    ctx.fillRect(0, 0, ctx.canvas.width, hexTop);
  }
  if (hexBottom < ctx.canvas.height) {
    ctx.fillRect(0, hexBottom, ctx.canvas.width, ctx.canvas.height - hexBottom);
  }
  if (hexLeft > 0) {
    ctx.fillRect(0, hexTop, hexLeft, hexHeight);
  }
  if (hexRight < ctx.canvas.width) {
    ctx.fillRect(hexRight, hexTop, ctx.canvas.width - hexRight, hexHeight);
  }

  const clipTop = Math.max(hexTop-1, 0);
  const clipBottom = Math.min(hexBottom+1, ctx.canvas.height);
  const clipLeft = Math.max(hexLeft-1, 0);
  const clipRight = Math.min(hexRight+1, ctx.canvas.width);

  ctx.beginPath();
  ctx.moveTo(clipLeft, clipTop);
	ctx.lineTo(clipLeft, hexTop + edge * 0.5 + 1);
	ctx.lineTo(hexLeft, hexTop + edge * 0.5);
	ctx.lineTo(hexMiddle, hexTop);
	ctx.lineTo(hexRight, hexTop + edge * 0.5);
	ctx.lineTo(clipRight, hexTop + edge * 0.5 + 1);
  ctx.lineTo(clipRight, clipTop);
  ctx.closePath();
  ctx.fill();

  ctx.beginPath();
  ctx.moveTo(clipLeft, clipBottom);
	ctx.lineTo(clipLeft, hexBottom - edge * 0.5 - 1);
	ctx.lineTo(hexLeft, hexBottom - edge * 0.5);
	ctx.lineTo(hexMiddle, hexBottom);
	ctx.lineTo(hexRight, hexBottom - edge * 0.5);
	ctx.lineTo(clipRight, hexBottom - edge * 0.5 - 1);
  ctx.lineTo(clipRight, clipBottom);
  ctx.closePath();
  ctx.fill();
}

function resetCtx(ctx) {
  ctx.globalAlpha = 1.0;
  ctx.globalCompositeOperation = 'source-over';
  ctx.lineWidth = 3;
  ctx.strokeStyle = "#FFFFFF";
}

function handleDownload(exporter) {
  const edge = getEdgeLength();
  const hexWidth = edge * Math.sqrt(3);
  const hexHeight = edge * 2;

  const canvas = document.createElement('canvas');
  canvas.width  = hexWidth;
  canvas.height = hexHeight;
  canvas.getContext('2d')
    .drawImage(document.getElementById('output'), getXOffset(), getYOffset(), hexWidth, hexHeight, 0, 0, hexWidth, hexHeight);

  exporter.href = canvas.toDataURL('image/png');
}

</script>
</head>
<body>
<div><input type="file" onchange="onFileSelected(event)"></div>
<div>x offset: <input type="number" id="x" oninput="onXChanged(this.value * 1)"/></div>
<div>y offset: <input type="number" id="y" oninput="onYChanged(this.value * 1)"/></div>
<div>edge: <input type="number" id="edge" oninput="redraw()"/><div>
<div><canvas id="output" height = "0" width = "0" style="border: 2px solid blueviolet"></canvas></div>
<div><a id="export" download="hexport.png" onclick="handleDownload(this)">Export</a></div>
</body>
</html>
